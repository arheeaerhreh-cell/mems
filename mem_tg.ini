import logging
import sqlite3
import random
from datetime import datetime
from telegram import (
    Update, 
    InlineKeyboardButton, 
    InlineKeyboardMarkup
)
from telegram.ext import (
    Application, 
    CommandHandler, 
    MessageHandler, 
    CallbackQueryHandler, 
    ContextTypes, 
    filters
)

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# –¢–æ–∫–µ–Ω –≤–∞—à–µ–≥–æ –±–æ—Ç–∞
BOT_TOKEN = "8475389602:AAFPKnvw7odvp2OOabHizKA0qL2rv_5A4FI"

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
def init_db():
    conn = sqlite3.connect('matchbot.db')
    cursor = conn.cursor()
    
    # –¢–∞–±–ª–∏—Ü–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS users (
            user_id INTEGER PRIMARY KEY,
            username TEXT,
            first_name TEXT,
            last_name TEXT,
            balance INTEGER DEFAULT 0,
            likes_given INTEGER DEFAULT 0,
            likes_received INTEGER DEFAULT 0,
            matches_count INTEGER DEFAULT 0,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )
    ''')
    
    # –¢–∞–±–ª–∏—Ü–∞ –ø–æ—Å—Ç–æ–≤ –¥–ª—è –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—è
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS posts (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id INTEGER,
            post_text TEXT,
            post_type TEXT,
            budget INTEGER DEFAULT 0,
            views INTEGER DEFAULT 0,
            clicks INTEGER DEFAULT 0,
            is_active BOOLEAN DEFAULT TRUE,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (user_id) REFERENCES users (user_id)
        )
    ''')
    
    # –¢–∞–±–ª–∏—Ü–∞ –ª–∞–π–∫–æ–≤
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS likes (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            from_user_id INTEGER,
            to_user_id INTEGER,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (from_user_id) REFERENCES users (user_id),
            FOREIGN KEY (to_user_id) REFERENCES users (user_id)
        )
    ''')
    
    # –¢–∞–±–ª–∏—Ü–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS views (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            viewer_id INTEGER,
            viewed_id INTEGER,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )
    ''')
    
    conn.commit()
    conn.close()

# –ö–æ–º–∞–Ω–¥–∞ /start
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    user_id = user.id
    
    # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–∞–∑—É
    conn = sqlite3.connect('matchbot.db')
    cursor = conn.cursor()
    cursor.execute(
        'INSERT OR IGNORE INTO users (user_id, username, first_name, last_name) VALUES (?, ?, ?, ?)',
        (user_id, user.username, user.first_name, user.last_name)
    )
    conn.commit()
    conn.close()
    
    # –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
    keyboard = [
        [InlineKeyboardButton("‚ù§Ô∏è –°–º–æ—Ç—Ä–µ—Ç—å –∞–Ω–∫–µ—Ç—ã", callback_data="browse_profiles")],
        [InlineKeyboardButton("üíé –ü—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ", callback_data="promotion")],
        [InlineKeyboardButton("üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", callback_data="stats")],
        [InlineKeyboardButton("üë§ –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å", callback_data="my_profile")],
        [InlineKeyboardButton("üìû –ù–∞–ø–∏—Å–∞—Ç—å –∞–≤—Ç–æ—Ä—É", callback_data="contact_author")]
    ]
    
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await update.message.reply_text(
        "üî• –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ MatchBot!\n\n"
        "–ó–Ω–∞–∫–æ–º—å—Å—è —Å –ª—é–¥—å–º–∏ –∏ –ø—Ä–æ–¥–≤–∏–≥–∞–π —Å–≤–æ–∏ –ø–æ—Å—Ç—ã!\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
        reply_markup=reply_markup
    )

# –ü–æ–ª—É—á–∏—Ç—å —Å–ª–µ–¥—É—é—â–∏–π –ø—Ä–æ—Ñ–∏–ª—å –¥–ª—è –ø–æ–∫–∞–∑–∞
def get_next_profile(user_id):
    conn = sqlite3.connect('matchbot.db')
    cursor = conn.cursor()
    
    # –ü–æ–ª—É—á–∞–µ–º ID —É–∂–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    cursor.execute('SELECT viewed_id FROM views WHERE viewer_id = ?', (user_id,))
    viewed_users = [row[0] for row in cursor.fetchall()]
    
    # –ü–æ–ª—É—á–∞–µ–º ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã—Ö —É–∂–µ –ª–∞–π–∫–∞–ª–∏
    cursor.execute('SELECT to_user_id FROM likes WHERE from_user_id = ?', (user_id,))
    liked_users = [row[0] for row in cursor.fetchall()]
    
    excluded_users = viewed_users + liked_users + [user_id]
    
    # –ò—â–µ–º —Å–ª—É—á–∞–π–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    query = '''
        SELECT user_id, username, first_name, last_name 
        FROM users 
        WHERE user_id NOT IN ({}) 
        ORDER BY RANDOM() 
        LIMIT 1
    '''.format(','.join('?' * len(excluded_users)))
    
    cursor.execute(query, excluded_users)
    user = cursor.fetchone()
    
    if user:
        # –î–æ–±–∞–≤–ª—è–µ–º –≤ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã–µ
        cursor.execute('INSERT INTO views (viewer_id, viewed_id) VALUES (?, ?)', (user_id, user[0]))
        conn.commit()
    
    conn.close()
    return user

# –ü—Ä–æ—Å–º–æ—Ç—Ä –∞–Ω–∫–µ—Ç
async def browse_profiles(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    
    user_id = query.from_user.id
    next_profile = get_next_profile(user_id)
    
    if not next_profile:
        await query.edit_message_text(
            "üòî –ù–∞ —Å–µ–≥–æ–¥–Ω—è –∞–Ω–∫–µ—Ç—ã –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å!\n\n"
            "–ó–∞–≥–ª—è–Ω–∏—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—å —Å–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å.",
            reply_markup=InlineKeyboardMarkup([
                [InlineKeyboardButton("üíé –ü—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ", callback_data="promotion")],
                [InlineKeyboardButton("üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="main_menu")]
            ])
        )
        return
    
    profile_user_id, username, first_name, last_name = next_profile
    
    # –°–ª—É—á–∞–π–Ω—ã–µ –æ–ø–∏—Å–∞–Ω–∏—è –¥–ª—è –ø—Ä–æ—Ñ–∏–ª–µ–π
    descriptions = [
        "–ò—â—É –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã—Ö —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–æ–≤ üó£Ô∏è",
        "–õ—é–±–ª—é –Ω–æ–≤—ã–µ –∑–Ω–∞–∫–æ–º—Å—Ç–≤–∞ üí´",
        "–û—Ç–∫—Ä—ã—Ç –¥–ª—è –æ–±—â–µ–Ω–∏—è üòä",
        "–ò—â—É –¥—Ä—É–∑–µ–π –∏ —Ö–æ—Ä–æ—à—É—é –∫–æ–º–ø–∞–Ω–∏—é üë•",
        "–ì–æ—Ç–æ–≤ –∫ –Ω–æ–≤—ã–º –∑–Ω–∞–∫–æ–º—Å—Ç–≤–∞–º! üöÄ",
        "–û–±–æ–∂–∞—é –∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è —Å –Ω–æ–≤—ã–º–∏ –ª—é–¥—å–º–∏ üåü",
        "–í—Å–µ–≥–¥–∞ —Ä–∞–¥ –Ω–æ–≤—ã–º –∑–Ω–∞–∫–æ–º—Å—Ç–≤–∞–º! üí´",
        "–ò—â—É –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã—Ö –ª—é–¥–µ–π –¥–ª—è –æ–±—â–µ–Ω–∏—è üéØ"
    ]
    
    profile_text = (
        f"üë§ {first_name} {last_name or ''}\n"
        f"üìù {random.choice(descriptions)}\n\n"
    )
    
    if username:
        profile_text += f"üí¨ @{username}"
    
    keyboard = [
        [
            InlineKeyboardButton("‚ù§Ô∏è –õ–∞–π–∫", callback_data=f"like_{profile_user_id}"),
            InlineKeyboardButton("üëé –î–∏–∑–ª–∞–π–∫", callback_data="dislike")
        ],
        [InlineKeyboardButton("üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="main_menu")]
    ]
    
    await query.edit_message_text(
        profile_text,
        reply_markup=InlineKeyboardMarkup(keyboard)
    )

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –ª–∞–π–∫–∞
async def handle_like(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    
    user_id = query.from_user.id
    liked_user_id = int(query.data.split('_')[1])
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–∞–π–∫ –≤ –±–∞–∑—É
    conn = sqlite3.connect('matchbot.db')
    cursor = conn.cursor()
    
    cursor.execute('INSERT INTO likes (from_user_id, to_user_id) VALUES (?, ?)', (user_id, liked_user_id))
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∑–∞–∏–º–Ω—ã–π –ª–∞–π–∫
    cursor.execute('SELECT id FROM likes WHERE from_user_id = ? AND to_user_id = ?', (liked_user_id, user_id))
    mutual_like = cursor.fetchone()
    
    if mutual_like:
        # –≠—Ç–æ –º—ç—Ç—á!
        cursor.execute('UPDATE users SET matches_count = matches_count + 1 WHERE user_id IN (?, ?)', (user_id, liked_user_id))
        
        # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –¥–ª—è –º—ç—Ç—á–∞
        cursor.execute('SELECT username FROM users WHERE user_id = ?', (liked_user_id,))
        matched_user = cursor.fetchone()
        
        match_text = "üéâ –£ –≤–∞—Å –º—ç—Ç—á!\n\n"
        if matched_user and matched_user[0]:
            match_text += f"üí¨ –ù–∞–ø–∏—à–∏: @{matched_user[0]}"
        else:
            match_text += "üí¨ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–∫–∞ –Ω–µ —É–∫–∞–∑–∞–ª username"
        
        await query.edit_message_text(
            match_text,
            reply_markup=InlineKeyboardMarkup([
                [InlineKeyboardButton("‚û°Ô∏è –°–ª–µ–¥—É—é—â–∏–π –ø—Ä–æ—Ñ–∏–ª—å", callback_data="browse_profiles")],
                [InlineKeyboardButton("üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="main_menu")]
            ])
        )
    else:
        # –ü—Ä–æ—Å—Ç–æ –ª–∞–π–∫
        await query.edit_message_text(
            "‚ù§Ô∏è –õ–∞–π–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!\n\n"
            "–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–≤–µ—Ç–∏—Ç –≤–∑–∞–∏–º–Ω–æ—Å—Ç—å—é - –≤—ã –ø–æ–ª—É—á–∏—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ!",
            reply_markup=InlineKeyboardMarkup([
                [InlineKeyboardButton("‚û°Ô∏è –°–ª–µ–¥—É—é—â–∏–π –ø—Ä–æ—Ñ–∏–ª—å", callback_data="browse_profiles")],
                [InlineKeyboardButton("üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="main_menu")]
            ])
        )
    
    # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    cursor.execute('UPDATE users SET likes_given = likes_given + 1 WHERE user_id = ?', (user_id,))
    cursor.execute('UPDATE users SET likes_received = likes_received + 1 WHERE user_id = ?', (liked_user_id,))
    
    conn.commit()
    conn.close()

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∏–∑–ª–∞–π–∫–∞
async def handle_dislike(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer("üëé –î–∏–∑–ª–∞–π–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω")
    
    # –ü—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ª–µ–¥—É—é—â–∏–π –ø—Ä–æ—Ñ–∏–ª—å
    await browse_profiles(update, context)

# –ú–µ–Ω—é –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—è
async def show_promotion(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    
    text = (
        "üíé **–ü—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ –≤–∞—à–µ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è**\n\n"
        "–£–≤–µ–ª–∏—á—å—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ –≤–∞—à–µ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è!\n\n"
        "**–¢–∞—Ä–∏—Ñ—ã:**\n"
        "‚Ä¢ üü¢ –ë–∞–∑–æ–≤—ã–π - 100‚ÇΩ (100 –ø–æ–∫–∞–∑–æ–≤)\n"
        "‚Ä¢ üü° –°—Ç–∞–Ω–¥–∞—Ä—Ç - 250‚ÇΩ (300 –ø–æ–∫–∞–∑–æ–≤)\n"
        "‚Ä¢ üî¥ –ü—Ä–µ–º–∏—É–º - 500‚ÇΩ (700 –ø–æ–∫–∞–∑–æ–≤)\n"
        "‚Ä¢ üíé VIP - 1000‚ÇΩ (1500 –ø–æ–∫–∞–∑–æ–≤)\n\n"
        "–î–ª—è –∑–∞–∫–∞–∑–∞ –ø–∏—à–∏—Ç–µ –∞–≤—Ç–æ—Ä—É –±–æ—Ç–∞ üëá"
    )
    
    keyboard = [
        [InlineKeyboardButton("üìû –ù–∞–ø–∏—Å–∞—Ç—å –∞–≤—Ç–æ—Ä—É", url="https://t.me/your_username")],
        [InlineKeyboardButton("üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="main_menu")]
    ]
    
    await query.edit_message_text(
        text,
        reply_markup=InlineKeyboardMarkup(keyboard),
        parse_mode='Markdown'
    )

# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
async def show_stats(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    
    user_id = query.from_user.id
    
    conn = sqlite3.connect('matchbot.db')
    cursor = conn.cursor()
    
    cursor.execute(
        'SELECT likes_given, likes_received, matches_count FROM users WHERE user_id = ?', 
        (user_id,)
    )
    stats = cursor.fetchone()
    conn.close()
    
    if stats:
        likes_given, likes_received, matches = stats
        
        text = (
            f"üìä **–í–∞—à–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:**\n\n"
            f"‚ù§Ô∏è –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ª–∞–π–∫–æ–≤: {likes_given}\n"
            f"üíå –ü–æ–ª—É—á–µ–Ω–æ –ª–∞–π–∫–æ–≤: {likes_received}\n"
            f"üéâ –ú—ç—Ç—á–µ–π: {matches}\n\n"
            f"üíé –ü—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ —É–≤–µ–ª–∏—á–∏—Ç –≤–∞—à—É –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç—å!"
        )
    else:
        text = "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
    
    keyboard = [
        [InlineKeyboardButton("üíé –ü—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ", callback_data="promotion")],
        [InlineKeyboardButton("üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="main_menu")]
    ]
    
    await query.edit_message_text(
        text,
        reply_markup=InlineKeyboardMarkup(keyboard),
        parse_mode='Markdown'
    )

# –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å
async def show_my_profile(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    
    user = query.from_user
    
    text = (
        f"üë§ **–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å:**\n\n"
        f"üÜî ID: {user.id}\n"
        f"üë§ –ò–º—è: {user.first_name}\n"
        f"üìõ –§–∞–º–∏–ª–∏—è: {user.last_name or '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}\n"
        f"üí¨ Username: @{user.username or '–ù–µ —É–∫–∞–∑–∞–Ω'}\n\n"
        f"üíé –î–ª—è –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ"
    )
    
    keyboard = [
        [InlineKeyboardButton("üíé –ü—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ", callback_data="promotion")],
        [InlineKeyboardButton("üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="main_menu")]
    ]
    
    await query.edit_message_text(
        text,
        reply_markup=InlineKeyboardMarkup(keyboard),
        parse_mode='Markdown'
    )

# –°–≤—è–∑—å —Å –∞–≤—Ç–æ—Ä–æ–º
async def contact_author(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    
    text = (
        "üìû **–°–≤—è–∑—å —Å –∞–≤—Ç–æ—Ä–æ–º**\n\n"
        "–ü–æ –≤–æ–ø—Ä–æ—Å–∞–º –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—è, —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–∞ –∏–ª–∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–º –ø—Ä–æ–±–ª–µ–º–∞–º:\n\n"
        "üí¨ –ù–∞–ø–∏—Å–∞—Ç—å: @CotRichard\n"
        "–ú—ã –≤—Å–µ–≥–¥–∞ —Ä–∞–¥—ã –ø–æ–º–æ—á—å! üöÄ"
    )
    
    keyboard = [
        [InlineKeyboardButton("üí¨ –ù–∞–ø–∏—Å–∞—Ç—å –≤ Telegram", url="https://t.me/CotRichard")],
        [InlineKeyboardButton("üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="main_menu")]
    ]
    
    await query.edit_message_text(
        text,
        reply_markup=InlineKeyboardMarkup(keyboard),
        parse_mode='Markdown'
    )

# –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
async def main_menu(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    
    keyboard = [
        [InlineKeyboardButton("‚ù§Ô∏è –°–º–æ—Ç—Ä–µ—Ç—å –∞–Ω–∫–µ—Ç—ã", callback_data="browse_profiles")],
        [InlineKeyboardButton("üíé –ü—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ", callback_data="promotion")],
        [InlineKeyboardButton("üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", callback_data="stats")],
        [InlineKeyboardButton("üë§ –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å", callback_data="my_profile")],
        [InlineKeyboardButton("üìû –ù–∞–ø–∏—Å–∞—Ç—å –∞–≤—Ç–æ—Ä—É", callback_data="contact_author")]
    ]
    
    await query.edit_message_text(
        "üè† **–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é**\n\n–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
        reply_markup=InlineKeyboardMarkup(keyboard),
        parse_mode='Markdown'
    )

# –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    # –ï—Å–ª–∏ —ç—Ç–æ –Ω–µ –∫–æ–º–∞–Ω–¥–∞, –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º
    if update.message and not update.message.text.startswith('/'):
        await update.message.reply_text(
            "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏!",
            reply_markup=InlineKeyboardMarkup([
                [InlineKeyboardButton("üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="main_menu")]
            ])
        )

# –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
def main():
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ë–î
    init_db()
    
    # –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    application = Application.builder().token(BOT_TOKEN).build()
    
    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥
    application.add_handler(CommandHandler("start", start))
    
    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ callback-–∑–∞–ø—Ä–æ—Å–æ–≤
    application.add_handler(CallbackQueryHandler(browse_profiles, pattern="^browse_profiles$"))
    application.add_handler(CallbackQueryHandler(show_promotion, pattern="^promotion$"))
    application.add_handler(CallbackQueryHandler(show_stats, pattern="^stats$"))
    application.add_handler(CallbackQueryHandler(show_my_profile, pattern="^my_profile$"))
    application.add_handler(CallbackQueryHandler(contact_author, pattern="^contact_author$"))
    application.add_handler(CallbackQueryHandler(main_menu, pattern="^main_menu$"))
    application.add_handler(CallbackQueryHandler(handle_like, pattern="^like_"))
    application.add_handler(CallbackQueryHandler(handle_dislike, pattern="^dislike$"))
    
    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))
    
    # –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
    application.run_polling()
    print("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω!")

if __name__ == '__main__':
    main()
